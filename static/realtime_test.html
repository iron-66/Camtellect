<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Realtime WebRTC Test</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    video, audio { width: 320px; height: 240px; background:#000; display:block; margin: 8px 0; }
    button { padding: 8px 12px; }
  </style>
</head>
<body>
  <h1>OpenAI Realtime WebRTC (audio+video)</h1>
  <button id="connectBtn">Connect</button>
  <video id="local" autoplay playsinline muted></video>
  <audio id="remote" autoplay></audio>
  <pre id="log"></pre>

<script>
const log = (...a) => (document.getElementById('log').textContent += a.join(' ') + '\n');

async function connect() {
  try {
    // 1) получаем эфемерный токен с нашего сервера
    const tokResp = await fetch('/realtime-session', { method: 'POST' });
    const { client_secret } = await tokResp.json();
    if (!client_secret) throw new Error('No ephemeral token');

    // 2) настраиваем WebRTC
    const pc = new RTCPeerConnection({
      iceServers: [{ urls: ["stun:stun.l.google.com:19302"] }]
    });

    pc.oniceconnectionstatechange = () => log('ice:', pc.iceConnectionState);
    pc.onconnectionstatechange = () => log('pc:', pc.connectionState);

    // remote audio (голос модели)
    pc.ontrack = (e) => {
      if (e.track.kind === 'audio') {
        document.getElementById('remote').srcObject = e.streams[0];
      }
    };

    // локальные треки (микрофон + камера)
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
    document.getElementById('local').srcObject = stream;
    stream.getTracks().forEach(t => pc.addTrack(t, stream));

    // 3) создаём SDP-offer и отправляем в OpenAI Realtime
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    const resp = await fetch(
      "https://api.openai.com/v1/realtime?model=gpt-realtime",
      {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${client_secret}`,
          "Content-Type": "application/sdp",
          "OpenAI-Beta": "realtime=v1"
        },
        body: offer.sdp
      }
    );

    const answer = { type: "answer", sdp: await resp.text() };
    await pc.setRemoteDescription(answer);
    log("Connected! Speaking…");

  } catch (e) {
    console.error(e); log('ERR:', e.message);
  }
}

document.getElementById('connectBtn').onclick = connect;
</script>
</body>
</html>
